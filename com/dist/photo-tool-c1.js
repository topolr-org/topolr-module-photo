window.topolr.source({"packet":[{"p":"photo.tool","h":"6f9dcdd3b3","c":"/**\r\n * @packet photo.tool;\r\n * @require photo.util.canvas;\r\n * @require util.file;\r\n * @css photo.style.photocutter;\r\n */\nModule({\r\n    name: \"photocutter\",\r\n    className: \"photocutter\",\r\n    extend: \"view\",\r\n    option: {\r\n        filename: \"file\",\r\n        url: \"\",\r\n        picWidth: 100,\r\n        picHeight: 100,\r\n        type: \".png,.gif,.jpg,.jpeg\",\r\n        rotateoffset: 10,\r\n        zoomoffset: 0.2,\r\n        tools: [\r\n            {type: \"zoomin\", icon: \"fa-search-plus\"},\r\n            {type: \"zoomout\", icon: \"fa-search-minus\"},\r\n            {type: \"rotateleft\", icon: \"fa-undo\"},\r\n            {type: \"rotateright\", icon: \"fa-repeat\"},\r\n            {type: \"download\", icon: \"fa-download\"},\r\n            {type: \"reset\", icon: \"fa-refresh\"}\r\n        ]\r\n    },\r\n    init: function (option) {\r\n        var ths = this;\r\n        var canvas = require(\"@canvas\");\r\n        option.sceneWidth = this.dom.width();\r\n        option.sceneHeight = this.dom.height() - 30;\r\n        var scene = this.dom.display();\r\n        var baseContainer = canvas.create(\"DisplayObjectContainer\", {\r\n            id: \"aa\",\r\n            width: option.sceneWidth,\r\n            height: option.sceneHeight,\r\n            x: 0,\r\n            y: 0\r\n        });\r\n        var r = Math.sqrt(option.sceneWidth * option.sceneWidth + option.sceneHeight * option.sceneHeight);\r\n        var imageContainer = canvas.create(\"DisplayObjectContainer\", {\r\n            id: \"imageContainer\",\r\n            width: r,\r\n            height: r,\r\n            x: -(r - option.sceneWidth) / 2,\r\n            y: -(r - option.sceneHeight) / 2,\r\n            init: function () {\r\n                this.ismove = false;\r\n                this.cleft = 0;\r\n                this.ctop = 0;\r\n            },\r\n            onmousedown: function (e) {\r\n                var b = this.getChildAt(0);\r\n                var a = b.getLocalRelativeRootPoint(e.pageX, e.pageY);\r\n                this.cleft = a.x - b.x();\r\n                this.ctop = a.y - b.y();\r\n            },\r\n            onmousemove: function (e) {\r\n                if (this.ismove) {\r\n                    var b = this.getChildAt(0);\r\n                    var a = b.getLocalRelativeRootPoint(e.pageX, e.pageY);\r\n                    var _x = a.x - this.cleft;\r\n                    var _y = a.y - this.ctop;\r\n                    if (this.getChildAt(0).width() > this.getChildAt(1).width() || this.getChildAt(0).height() > this.getChildAt(1).height()) {\r\n                        if (_x < this.getChildAt(1).x()) {\r\n                            if (_x > this.getChildAt(1).x() - (this.getChildAt(0).width() - this.getChildAt(1).width())) {\r\n                                b.x(a.x - this.cleft);\r\n                            } else {\r\n                                b.x(this.getChildAt(1).x() - (this.getChildAt(0).width() - this.getChildAt(1).width()));\r\n                            }\r\n                        } else {\r\n                            b.x(this.getChildAt(1).x());\r\n                        }\r\n                        if (_y < this.getChildAt(1).y()) {\r\n                            if (_y > this.getChildAt(1).y() - (this.getChildAt(0).height() - this.getChildAt(1).height())) {\r\n                                b.y(a.y - this.ctop);\r\n                            } else {\r\n                                b.y(this.getChildAt(1).y() - (this.getChildAt(0).height() - this.getChildAt(1).height()));\r\n                            }\r\n                        } else {\r\n                            b.y(this.getChildAt(1).y());\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            onmouseup: function () {\r\n                this.ismove = false;\r\n            }\r\n        });\r\n        imageContainer.rotatePoint(option.sceneWidth / 2, option.sceneHeight / 2);\r\n        var image = canvas.create(\"ImageDisplay\", {\r\n            id: \"image\",\r\n            width: option.sceneWidth,\r\n            height: option.sceneHeight,\r\n            x: (r - option.sceneWidth) / 2,\r\n            y: (r - option.sceneHeight) / 2,\r\n            rotate: 0,\r\n            onmousedown: function () {\r\n                this.parent().ismove = true;\r\n            }\r\n        });\r\n        image.rotatePoint((r - option.sceneWidth) / 2, (r - option.sceneHeight) / 2);\r\n        var squart = canvas.create(\"SquartDisplay\", {\r\n            id: \"squart\",\r\n            width: option.picWidth,\r\n            height: option.picHeight,\r\n            x: (r - option.picWidth) / 2,\r\n            y: (r - option.picHeight) / 2,\r\n            onmousedown: function () {\r\n                this.parent().ismove = true;\r\n            }\r\n        });\r\n\r\n        var mask = canvas.create(\"DisplayObjectContainer\", {\r\n            id: \"squart\",\r\n            width: option.sceneWidth,\r\n            height: option.sceneHeight,\r\n            x: 0,\r\n            y: 0,\r\n            alpha: 0.6,\r\n            event: false,\r\n            backgroundColor: \"rgba(36,33,33,1)\"\r\n        });\r\n        var m1 = canvas.create(\"SquartDisplay\", {\r\n            id: \"squart\",\r\n            width: (option.sceneWidth - option.picWidth) / 2,\r\n            height: option.sceneHeight,\r\n            x: 0,\r\n            y: 0,\r\n            backgroundColor: \"rgba(36,33,33,1)\"\r\n        });\r\n        var m2 = canvas.create(\"SquartDisplay\", {\r\n            id: \"squart\",\r\n            width: option.picWidth,\r\n            height: (option.sceneHeight - option.picHeight) / 2,\r\n            x: (option.sceneWidth - option.picWidth) / 2,\r\n            y: 0,\r\n            backgroundColor: \"rgba(36,33,33,1)\"\r\n        });\r\n        var m3 = canvas.create(\"SquartDisplay\", {\r\n            id: \"squart\",\r\n            width: (option.sceneWidth - option.picWidth) / 2,\r\n            height: option.sceneHeight,\r\n            x: (option.sceneWidth - option.picWidth) / 2 + option.picWidth,\r\n            y: 0,\r\n            backgroundColor: \"rgba(36,33,33,1)\"\r\n        });\r\n        var m4 = canvas.create(\"SquartDisplay\", {\r\n            id: \"squart\",\r\n            width: option.picWidth,\r\n            height: (option.sceneHeight - option.picHeight) / 2,\r\n            x: (option.sceneWidth - option.picWidth) / 2,\r\n            y: (option.sceneHeight - option.picHeight) / 2 + option.picHeight,\r\n            backgroundColor: \"rgba(36,33,33,1)\"\r\n        });\r\n        var m5 = canvas.create(\"SquartDisplay\", {\r\n            id: \"squart\",\r\n            width: option.picWidth,\r\n            height: option.picHeight,\r\n            x: (option.sceneWidth - option.picWidth) / 2,\r\n            y: (option.sceneHeight - option.picHeight) / 2,\r\n            borderSize: 3,\r\n            borderColor: \"white\"\r\n        });\r\n        mask.addChild(m1).addChild(m2).addChild(m3).addChild(m4).addChild(m5);\r\n        imageContainer.addChild(image).addChild(squart);\r\n        baseContainer.addChild(imageContainer);\r\n        scene.addChild(baseContainer);\r\n        scene.addChild(mask);\r\n        this.image = image;\r\n        this.imageContainer = imageContainer;\r\n        this.baseContainer = baseContainer;\r\n        this.r = r;\r\n        var str = \"<div class='tools'>\";\r\n        for (var i in option.tools) {\r\n            str += \"<div class='tbtn' type='\" + option.tools[i].type + \"'><i class='fa \" + option.tools[i].icon + \"'></i></div>\";\r\n        }\r\n        str += \"<div class='fbtn'><i class='fa fa-folder-open'></i><input type='file' accept='\" + option.type + \"'></div>\";\r\n        str += \"</div>\";\r\n        var b = $(str).appendTo(this.dom);\r\n        b.find(\".tbtn\").each(function () {\r\n            $(this).click(function () {\r\n                var type = $(this).attr(\"type\");\r\n                ths.dispatchEvent(type, {\r\n                    btn: $(this)\r\n                });\r\n            });\r\n        });\r\n        b.find(\"input\").bind(\"change\", function (e) {\r\n            var file = e.target.files || e.dataTransfer.files;\r\n            ths.setImage(file);\r\n        });\r\n        $(\"<div class='mask'>\" +\r\n            \"<div class='openfile'>打开图片<input type='file' accept='\" + option.type + \"'></div>\" +\r\n            \"</div>\").appendTo(this.dom).find(\"input\").bind(\"change\", function (e) {\r\n            var file = e.target.files || e.dataTransfer.files;\r\n            if (file.length > 0) {\r\n                ths.dom.find(\".mask\").remove();\r\n                ths.setImage(file);\r\n            }\r\n        });\r\n    },\r\n    setImage: function (files) {\r\n        var image = this.image, ths = this;\r\n        if (files.length > 0) {\r\n            var file = require(\"@file\");\r\n            var filex = file.set(files[0]);\r\n            filex.getImage(function (pimage) {\r\n                var ximage = pimage, _w = ximage.width, _h = ximage.height;\r\n                image.canvas.width = _w;\r\n                image.canvas.height = _h;\r\n                image.props({\r\n                    width: _w,\r\n                    height: _h,\r\n                    x: (ths.r - _w) / 2,\r\n                    y: (ths.r - _h) / 2,\r\n                    rotate: 0\r\n                });\r\n                image.setImage(this, \"fit\");\r\n                ths.imageContainer.rotate(0);\r\n            });\r\n        }\r\n    },\r\n    zoomIn: function () {\r\n        var image = this.image, offset = this.option.zoomoffset;\r\n        var _w = image.width() + image.width() * offset;\r\n        if (_w / image.image.width <= 5) {\r\n            image.props({\r\n                width: _w,\r\n                height: image.height() + image.height() * offset,\r\n                x: image.x() - image.width() * offset / 2,\r\n                y: image.y() - image.height() * offset / 2\r\n            });\r\n        }\r\n    },\r\n    zoomOut: function () {\r\n        var image = this.image, offset = this.option.zoomoffset;\r\n        var _w = image.width() - image.width() * offset;\r\n        var _h = image.height() - image.height() * offset;\r\n        if (_w < this.option.picWidth) {\r\n            _w = this.option.picWidth;\r\n            _h = image.height() / image.width() * _w;\r\n            if (_h < this.option.picHeight) {\r\n                _h = this.option.picHeight;\r\n                _w = image.width() / image.height() * _h;\r\n            }\r\n        }\r\n        if (_h < this.option.picHeight) {\r\n            _h = this.option.picHeight;\r\n            _w = image.width() / image.height() * _h;\r\n            if (_w < this.option.picWidth) {\r\n                _w = this.option.picWidth;\r\n                _h = image.height() / image.width() * _w;\r\n            }\r\n        }\r\n        var _x = image.x() + image.width() * offset / 2;\r\n        var _y = image.y() + image.height() * offset / 2;\r\n        var container = this.imageContainer;\r\n        if (_x < container.getChildAt(1).x()) {\r\n            if (_x > container.getChildAt(1).x() - (container.getChildAt(0).width() - container.getChildAt(1).width())) {\r\n            } else {\r\n                _x = container.getChildAt(1).x() - (container.getChildAt(0).width() - container.getChildAt(1).width());\r\n            }\r\n        } else {\r\n            _x = container.getChildAt(1).x();\r\n        }\r\n        if (_y < container.getChildAt(1).y()) {\r\n            if (_y > container.getChildAt(1).y() - (container.getChildAt(0).height() - container.getChildAt(1).height())) {\r\n            } else {\r\n                _y = container.getChildAt(1).y() - (container.getChildAt(0).height() - container.getChildAt(1).height());\r\n            }\r\n        } else {\r\n            _y = container.getChildAt(1).y();\r\n        }\r\n        if (_w + _x < container.getChildAt(1).x() + container.getChildAt(1).width()) {\r\n            _x = container.getChildAt(1).x() + container.getChildAt(1).width() - _w;\r\n        }\r\n        if (_h + _y < container.getChildAt(1).y() + container.getChildAt(1).height()) {\r\n            _y = container.getChildAt(1).y() + container.getChildAt(1).height() - _h;\r\n        }\r\n        image.props({\r\n            width: _w,\r\n            height: _h,\r\n            x: _x,\r\n            y: _y\r\n        });\r\n    },\r\n    rotateRight: function () {\r\n        this.imageContainer.rotate(this.imageContainer.rotate() + this.option.rotateoffset);\r\n    },\r\n    rotateLeft: function () {\r\n        this.imageContainer.rotate(this.imageContainer.rotate() - this.option.rotateoffset);\r\n    },\r\n    download: function () {\r\n        var option = this.option;\r\n        var uri = this.baseContainer.getImageDate((option.sceneWidth - option.picWidth) / 2, (option.sceneHeight - option.picHeight) / 2, option.picWidth, option.picHeight);\r\n        var file = require(\"@file\");\r\n        var blob = file.getBlobFromURI(uri);\r\n        file.saveAs(blob, \"photocutter.png\");\r\n    },\r\n    reset: function () {\r\n        var ximage = this.image.image, _w = ximage.width, _h = ximage.height;\r\n        this.image.props({\r\n            width: _w,\r\n            height: _h,\r\n            x: (this.r - _w) / 2,\r\n            y: (this.r - _h) / 2,\r\n            rotate: 0\r\n        });\r\n        this.imageContainer.rotate(0);\r\n    },\r\n    upload: function () {\r\n        var option = this.option;\r\n        var uri = this.baseContainer.getImageDate((option.sceneWidth - option.picWidth) / 2, (option.sceneHeight - option.picHeight) / 2, option.picWidth, option.picHeight);\r\n        var file = require(\"@file\");\r\n        var blob = file.getBlobFromURI(uri);\r\n        var ths = this;\r\n        var formdata = new FormData();\r\n        formdata.append(option.name, blob);\r\n        $.ajax({\r\n            url: option.url || null,\r\n            data: formdata,\r\n            method: \"post\",\r\n            dataType: \"json\",\r\n            handlers: {\r\n                load: function (e) {\r\n                },\r\n                progress: function (e) {\r\n                },\r\n                error: function (e) {\r\n                }\r\n            }\r\n        });\r\n    },\r\n    event_zoomin: function () {\r\n        this.zoomIn();\r\n    },\r\n    event_zoomout: function () {\r\n        this.zoomOut();\r\n    },\r\n    event_rotateleft: function () {\r\n        this.rotateLeft();\r\n    },\r\n    event_rotateright: function () {\r\n        this.rotateRight();\r\n    },\r\n    event_download: function () {\r\n        this.download();\r\n    },\r\n    event_reset: function () {\r\n        this.reset();\r\n    }\r\n});"}],"css":[{"p":"photo.style.photocutter","h":"9545ad58ee","c":".photocutter {\n  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAAAAAByaaZbAAAACXBIWXMAAAsTAAALEwEAmpwYAAADGWlDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjaY2BgnuDo4uTKJMDAUFBUUuQe5BgZERmlwH6egY2BmYGBgYGBITG5uMAxIMCHgYGBIS8/L5UBA3y7xsDIwMDAcFnX0cXJlYE0wJpcUFTCwMBwgIGBwSgltTiZgYHhCwMDQ3p5SUEJAwNjDAMDg0hSdkEJAwNjAQMDg0h2SJAzAwNjCwMDE09JakUJAwMDg3N+QWVRZnpGiYKhpaWlgmNKflKqQnBlcUlqbrGCZ15yflFBflFiSWoKAwMD1A4GBgYGXpf8EgX3xMw8BUNTVQYqg4jIKAX08EGIIUByaVEZhMXIwMDAIMCgxeDHUMmwiuEBozRjFOM8xqdMhkwNTJeYNZgbme+y2LDMY2VmzWa9yubEtoldhX0mhwBHJycrZzMXM1cbNzf3RB4pnqW8xryH+IL5nvFXCwgJrBZ0E3wk1CisKHxYJF2UV3SrWJw4p/hWiRRJYcmjUhXSutJPZObIhsoJyp2V71HwUeRVvKA0RTlKRUnltepWtUZ1Pw1Zjbea+7QmaqfqWOsK6b7SO6I/36DGMMrI0ljS+LfJPdPDZivM+y0qLBOtfKwtbFRtRexY7L7aP3e47XjB6ZjzXpetruvdVrov9VjkudBrgfdCn8W+y/xW+a8P2Bq4N+hY8PmQW6HPwr5EMEUKRilFG8e4xUbF5cW3JMxO3Jx0Nvl5KlOaXLpNRlRmVdas7D059/KY8tULfAqLi2YXHy55WyZR7lJRWDmv6mz131q9uvj6SQ3HGn83G7Skt85ru94h2Ond1d59uJehz76/bsK+if8nO05pnXpiOu+M4JmzZj2aozW3ZN6+BVwLwxYtXvxxqcOyCcsfrjRe1br65lrddU3rb2402NSx+cFWq21Tt3/Y6btr1R6Oven7jh9QP9h56PURv6Obj4ufqD355LT3mS3nZM+3X/h0Ke7yqasW15bdEL3ZeuvrnfS7N+/7PDjwyPTx6qeKz2a+EHzZ9Zr5Td3bn+9LP3z6VPD53de8b+9+5P/88Lv4z7d/Vf//AwAqvx2K829RWwAAACBjSFJNAAB6JQAAgIMAAPn/AACA6QAAdTAAAOpgAAA6mAAAF2+SX8VGAAAAPElEQVR42mL8zwABZ6G0MQE+EwOJYFQDMYCF2PA3Hg1WWmpgHM0Po/lhVMNofhjND6MasAAAAAAA//8DAHstFMgoxduqAAAAAElFTkSuQmCC) repeat;\n  position: relative;\n  width: 100%;\n  height: 100%;\n  box-shadow: 0 0 10px #AAA5A5;\n  -webkit-user-select: none;\n     -moz-user-select: none;\n      -ms-user-select: none;\n          user-select: none;\n  cursor: default; }\n  .photocutter canvas {\n    position: absolute;\n    left: 0;\n    top: 0; }\n  .photocutter .tools {\n    line-height: 30px;\n    background: white;\n    position: absolute;\n    left: 0;\n    bottom: 0;\n    right: 0; }\n  .photocutter .tbtn {\n    line-height: 30px;\n    width: 30px;\n    text-align: center;\n    display: inline-block;\n    background: white; }\n    .photocutter .tbtn:hover {\n      background: #F0F0F0; }\n  .photocutter .fbtn {\n    line-height: 30px;\n    text-align: center;\n    width: 30px;\n    position: relative;\n    display: inline-block; }\n    .photocutter .fbtn input {\n      display: inline-block;\n      width: 30px;\n      height: 30px;\n      position: absolute;\n      left: 0;\n      top: 0;\n      opacity: 0; }\n    .photocutter .fbtn:hover {\n      background: #F0F0F0; }\n  .photocutter .mask {\n    position: absolute;\n    left: 0;\n    top: 0;\n    right: 0;\n    bottom: 0;\n    background: rgba(255, 255, 255, 0.6); }\n    .photocutter .mask .openfile {\n      width: 100px;\n      height: 60px;\n      position: absolute;\n      left: 50%;\n      top: 50%;\n      margin-left: -50px;\n      margin-top: -30px;\n      line-height: 30px;\n      text-align: center; }\n      .photocutter .mask .openfile input {\n        display: inline-block;\n        width: 100px;\n        height: 60px;\n        position: absolute;\n        left: 0;\n        top: 0;\n        opacity: 0; }\n"}]});